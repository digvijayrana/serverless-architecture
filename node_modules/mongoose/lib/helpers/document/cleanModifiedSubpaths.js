'use strict';

/*!
 * ignore
 */

module.exports = function cleanModifiedSubpaths(doc, path, options) {
  options = options || {};
  const skipDocArrays = options.skipDocArrays;

  let deleted = 0;
  if (!doc) {
    return deleted;
  }

<<<<<<< HEAD
  for (const modifiedPath of Object.keys(doc.$__.activePaths.getStatePaths('modify'))) {
=======
  for (const modifiedPath of Object.keys(doc.$__.activePaths.states.modify)) {
>>>>>>> fd4215aa5028bc75f532153c8e97a44d89c0c47d
    if (skipDocArrays) {
      const schemaType = doc.$__schema.path(modifiedPath);
      if (schemaType && schemaType.$isMongooseDocumentArray) {
        continue;
      }
    }
    if (modifiedPath.startsWith(path + '.')) {
<<<<<<< HEAD
      doc.$__.activePaths.clearPath(modifiedPath);
=======
      delete doc.$__.activePaths.states.modify[modifiedPath];
>>>>>>> fd4215aa5028bc75f532153c8e97a44d89c0c47d
      ++deleted;

      if (doc.$isSubdocument) {
        const owner = doc.ownerDocument();
        const fullPath = doc.$__fullPath(modifiedPath);
<<<<<<< HEAD
        owner.$__.activePaths.clearPath(fullPath);
=======
        delete owner.$__.activePaths.states.modify[fullPath];
>>>>>>> fd4215aa5028bc75f532153c8e97a44d89c0c47d
      }
    }
  }
  return deleted;
};
